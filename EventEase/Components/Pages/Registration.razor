@page "/event/{eventId:int}/register"
@using EventEase.Models
@using EventEase.Services
@using Microsoft.AspNetCore.Components.Web
@inject EventService EventService
@inject StateService StateService
@inject NavigationManager Navigation

<PageTitle>Register - EventEase</PageTitle>

<div class="registration-container">
    @if (eventItem != null && eventItem.IsRegistrationOpen)
    {
        <div class="registration-content">
            <div class="registration-header">
                <a href="/event/@EventId" class="back-link">
                    <i class="bi bi-arrow-left"></i> Back to Event Details
                </a>
                <h1>Event Registration</h1>
                <p class="event-name-reg">@eventItem.EventName</p>
            </div>

            @if (!isRegistered)
            {
                <div class="registration-form">
                    <div class="event-summary">
                        <h3>Event Summary</h3>
                        <div class="summary-item">
                            <i class="bi bi-calendar3"></i>
                            <span>@eventItem.EventDate.ToString("dd MMMM yyyy, HH:mm")</span>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-geo-alt"></i>
                            <span>@eventItem.EventLocation</span>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-tag"></i>
                            <span>@eventItem.Category</span>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Personal Information</h3>
                        
                        <div class="form-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" 
                                   id="fullName" 
                                   @bind="fullName" 
                                   placeholder="Your full name"
                                   class="form-input" />
                            @if (showValidation && (string.IsNullOrWhiteSpace(fullName) || fullName.Length < 3))
                            {
                                <span class="validation-error">
                                    @if (string.IsNullOrWhiteSpace(fullName))
                                    {
                                        <text>Full name is required</text>
                                    }
                                    else
                                    {
                                        <text>Full name must be at least 3 characters</text>
                                    }
                                </span>
                            }
                        </div>

                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" 
                                   id="email" 
                                   @bind="email" 
                                   placeholder="example@email.com"
                                   class="form-input" />
                            @if (showValidation && (string.IsNullOrWhiteSpace(email) || !IsValidEmail(email)))
                            {
                                <span class="validation-error">
                                    @if (string.IsNullOrWhiteSpace(email))
                                    {
                                        <text>Email is required</text>
                                    }
                                    else
                                    {
                                        <text>Please enter a valid email address</text>
                                    }
                                </span>
                            }
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone *</label>
                            <input type="tel" 
                                   id="phone" 
                                   @bind="phone" 
                                   placeholder="05XX XXX XX XX"
                                   class="form-input" />
                            @if (showValidation && (string.IsNullOrWhiteSpace(phone) || !IsValidPhone(phone)))
                            {
                                <span class="validation-error">
                                    @if (string.IsNullOrWhiteSpace(phone))
                                    {
                                        <text>Phone number is required</text>
                                    }
                                    else
                                    {
                                        <text>Please enter a valid phone number (at least 10 digits)</text>
                                    }
                                </span>
                            }
                        </div>

                        <div class="form-group">
                            <label for="company">Company / Organization</label>
                            <input type="text" 
                                   id="company" 
                                   @bind="company" 
                                   placeholder="Company name (optional)"
                                   class="form-input" />
                        </div>

                        <div class="form-group">
                            <label for="specialRequests">Special Requests / Notes</label>
                            <textarea id="specialRequests" 
                                      @bind="specialRequests" 
                                      placeholder="Dietary restrictions, accessibility needs, etc."
                                      rows="4"
                                      class="form-textarea"></textarea>
                        </div>

                        <div class="form-group-checkbox">
                            <input type="checkbox" 
                                   id="acceptTerms" 
                                   @bind="acceptTerms" />
                            <label for="acceptTerms">
                                <a href="#" class="terms-link">Terms of Use</a> and 
                                <a href="#" class="terms-link">Privacy Policy</a> I accept *
                            </label>
                        </div>
                        @if (showValidation && !acceptTerms)
                        {
                            <span class="validation-error">You must accept the terms</span>
                        }

                        <div class="form-group-checkbox">
                            <input type="checkbox" 
                                   id="newsletter" 
                                   @bind="newsletter" />
                            <label for="newsletter">
                                I want to receive notifications about future events
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-cancel" @onclick='() => Navigation.NavigateTo($"/event/{EventId}")'>
                            Cancel
                        </button>
                        <button class="btn-submit" @onclick="HandleSubmit">
                            <i class="bi bi-check-circle"></i>
                            Complete Registration
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="success-message">
                    <div class="success-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h2>Registration Successful!</h2>
                    <p>Your event details and QR code have been sent to your email address.</p>
                    <div class="success-details">
                        <p><strong>Reference No:</strong> @registrationReference</p>
                        <p><strong>Registrant:</strong> @fullName</p>
                        <p><strong>Email:</strong> @email</p>
                    </div>
                    <div class="success-info">
                        <i class="bi bi-info-circle"></i>
                        <p>Please show your reference number at the event entrance.</p>
                    </div>
                    <div class="success-actions">
                        <button class="btn-primary" @onclick='() => Navigation.NavigateTo("/")'>
                            Back to Home
                        </button>
                        <button class="btn-secondary" @onclick='() => Navigation.NavigateTo($"/event/{EventId}")'>
                            Event Details
                        </button>
                        <button class="btn-secondary" @onclick='() => Navigation.NavigateTo($"/event/{EventId}/attendance")'>
                            Attendance Tracking
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else if (eventItem != null && !eventItem.IsRegistrationOpen)
    {
        <div class="error-message">
            <i class="bi bi-exclamation-triangle"></i>
            <h2>Registration Closed</h2>
            <p>Registrations for this event are closed.</p>
            <button class="btn-back" @onclick='() => Navigation.NavigateTo("/")'>
                Back to Home
            </button>
        </div>
    }
    else
    {
        <div class="error-message">
            <i class="bi bi-exclamation-triangle"></i>
            <h2>Event Not Found</h2>
            <p>The event you are looking for does not exist.</p>
            <button class="btn-back" @onclick='() => Navigation.NavigateTo("/")'>
                Back to Home
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public int EventId { get; set; }

    private Event? eventItem;
    private bool isRegistered = false;
    private bool showValidation = false;
    private string registrationReference = string.Empty;

    // Form fields with two-way data binding
    private string fullName = string.Empty;
    private string email = string.Empty;
    private string phone = string.Empty;
    private string company = string.Empty;
    private string specialRequests = string.Empty;
    private bool acceptTerms = false;
    private bool newsletter = false;

    protected override void OnInitialized()
    {
        eventItem = EventService.GetEventById(EventId);
    }

    private void HandleSubmit()
    {
        showValidation = true;

        if (ValidateForm())
        {
            try
            {
                // Register for the event using StateService
                var registration = StateService.AddRegistration(
                    EventId, 
                    fullName, 
                    email, 
                    phone, 
                    company, 
                    specialRequests, 
                    newsletter
                );
                
                if (registration != null)
                {
                    // Also update EventService for backwards compatibility
                    EventService.RegisterForEvent(EventId);
                    
                    // Store reference number for display
                    registrationReference = registration.ReferenceNumber;
                    isRegistered = true;
                    
                    // In a real application, you would save registration data to database
                    // and send confirmation email
                }
                else
                {
                    Console.WriteLine("Registration failed - could not create registration");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Registration error: {ex.Message}");
            }
        }
    }

    private bool ValidateForm()
    {
        // Enhanced validation with email and phone format checking
        if (string.IsNullOrWhiteSpace(fullName) || fullName.Length < 3)
            return false;
            
        if (string.IsNullOrWhiteSpace(email) || !IsValidEmail(email))
            return false;
            
        if (string.IsNullOrWhiteSpace(phone) || !IsValidPhone(phone))
            return false;
            
        if (!acceptTerms)
            return false;
            
        return true;
    }
    
    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
    
    private bool IsValidPhone(string phone)
    {
        // Remove spaces and check if it contains only digits and has reasonable length
        var cleanPhone = phone.Replace(" ", "").Replace("-", "");
        return cleanPhone.Length >= 10 && cleanPhone.All(char.IsDigit);
    }
}
