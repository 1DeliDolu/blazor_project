@using EventEase.Models

<div class="event-card">
    <div class="event-card-image">
        @if (!string.IsNullOrEmpty(EventItem?.ImageUrl))
        {
            <img src="@EventItem.ImageUrl" alt="@EventItem.EventName" />
        }
        else
        {
            <div class="event-card-placeholder">
                <i class="bi bi-calendar-event"></i>
            </div>
        }
    </div>
    
    <div class="event-card-content">
        <div class="event-card-header">
            <h3 class="event-card-title">@EventItem?.EventName</h3>
            <span class="event-card-category">@EventItem?.Category</span>
        </div>
        
        <div class="event-card-details">
            <div class="event-detail">
                <i class="bi bi-calendar3"></i>
                <span>@EventItem?.EventDate.ToString("dd MMMM yyyy, HH:mm")</span>
            </div>
            
            <div class="event-detail">
                <i class="bi bi-geo-alt"></i>
                <span>@EventItem?.EventLocation</span>
            </div>
            
            <div class="event-detail">
                <i class="bi bi-people"></i>
                <span>@EventItem?.CurrentAttendees / @EventItem?.MaxAttendees people</span>
            </div>
        </div>
        
        <p class="event-card-description">@EventItem?.Description</p>
        
        <div class="event-card-footer">
            <div class="availability-badge @GetAvailabilityClass()">
                @GetAvailabilityText()
            </div>
            
            <button class="btn-primary" 
                    @onclick="OnViewDetails"
                    disabled="@(!EventItem?.IsRegistrationOpen ?? true)">
                View Details
            </button>
        </div>
    </div>
</div>

@code {
    /// <summary>
    /// The event item to display in the card
    /// </summary>
    [Parameter]
    public Event? EventItem { get; set; }

    /// <summary>
    /// Callback event when view details button is clicked
    /// </summary>
    [Parameter]
    public EventCallback<int> OnViewDetailsClicked { get; set; }

    /// <summary>
    /// Handles the view details button click
    /// </summary>
    private async Task OnViewDetails()
    {
        // Null check and validation before navigation
        if (EventItem != null && EventItem.Id > 0)
        {
            try
            {
                await OnViewDetailsClicked.InvokeAsync(EventItem.Id);
            }
            catch (Exception ex)
            {
                // Log error in production
                Console.WriteLine($"Navigation error: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Gets the CSS class for availability badge based on registration status
    /// </summary>
    private string GetAvailabilityClass()
    {
        if (EventItem == null) return "unavailable";
        
        if (!EventItem.IsRegistrationOpen)
            return "unavailable";
        
        // Prevent division by zero
        if (EventItem.MaxAttendees <= 0)
            return "unavailable";
            
        var availableSeats = EventItem.MaxAttendees - EventItem.CurrentAttendees;
        
        // Ensure non-negative seats
        if (availableSeats < 0)
            availableSeats = 0;
            
        var availabilityPercentage = (double)availableSeats / EventItem.MaxAttendees * 100;
        
        return availabilityPercentage switch
        {
            > 50 => "available",
            > 20 => "limited",
            _ => "almost-full"
        };
    }

    /// <summary>
    /// Gets the availability text based on registration status
    /// </summary>
    private string GetAvailabilityText()
    {
        if (EventItem == null) return "No information";
        
        if (!EventItem.IsRegistrationOpen)
            return "Registration Closed";
        
        if (EventItem.MaxAttendees <= 0)
            return "No capacity info";
            
        var availableSeats = Math.Max(0, EventItem.MaxAttendees - EventItem.CurrentAttendees);
        return availableSeats > 0 ? $"{availableSeats} seats available" : "Sold out";
    }
}
